<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polaroid Board v11 (Sync)</title>
    <style>
        /* --- –°–¢–ò–õ–ò --- */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; user-select: none; -webkit-user-select: none; touch-action: none; background-color: #aa7e56; background-image: radial-gradient(transparent 90%, rgba(0,0,0,0.1) 90%), radial-gradient(transparent 90%, rgba(0,0,0,0.1) 90%); background-size: 20px 20px; background-position: 0 0, 10px 10px; transition: background-size 0.3s ease-out; }
        .viewport { width: 100%; height: 100%; overflow: hidden; position: relative; box-shadow: inset 0 0 150px rgba(0,0,0,0.4); cursor: grab; }
        .viewport:active { cursor: grabbing; }
        .board { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transform-origin: 0 0; pointer-events: none; }
        
        /* –î–æ–±–∞–≤–∏–ª–∏ transition –¥–ª—è left –∏ top, —á—Ç–æ–±—ã —Ñ–æ—Ç–æ –ø–ª–∞–≤–Ω–æ –ø–æ–ª–∑–ª–æ –∫ –Ω–æ–≤–æ–º—É –º–µ—Å—Ç—É, –µ—Å–ª–∏ –µ–≥–æ –ø–æ–¥–≤–∏–Ω—É–ª –¥—Ä—É–≥ */
        .polaroid { 
            position: absolute; background-color: white; padding: 10px 10px 35px 10px; 
            box-shadow: 5px 10px 20px rgba(0,0,0,0.3); width: 200px; 
            transition: box-shadow 0.3s, left 0.3s ease-out, top 0.3s ease-out; /* –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ */
            cursor: grab; 
            transform-origin: top center; 
            animation: sway 4s ease-in-out infinite alternate; 
            pointer-events: auto; 
        }
        
        @media (max-width: 600px) { .polaroid { width: 140px; padding: 6px 6px 25px 6px; font-size: 0.8rem; } }

        .polaroid.dragging { 
            cursor: grabbing; animation: none; 
            transform: scale(1.1) rotate(0deg) !important; 
            box-shadow: 20px 40px 50px rgba(0,0,0,0.5); z-index: 9999 !important; 
            transition: none; /* –£–±–∏—Ä–∞–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏, —á—Ç–æ–±—ã –Ω–µ "–º—ã–ª–∏–ª–æ" */
        }
        
        .polaroid.falling {
            animation: drop 1s ease-in forwards !important;
            pointer-events: none; z-index: 100;
        }

        .polaroid:hover { z-index: 10; }
        .polaroid img { width: 100%; height: auto; display: block; pointer-events: none; filter: sepia(20%); }

        .pin {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 15px; height: 15px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff4d4d, #990000);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); z-index: 20;
            cursor: pointer;
        }
        .pin:hover { transform: translateX(-50%) scale(1.2); }
        
        .polaroid::before { 
            content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); 
            width: 4px; height: 8px; background: #aaa; z-index: 1; 
        }

        @keyframes sway { 0% { transform: rotate(-2deg); } 100% { transform: rotate(2deg); } }
        @keyframes drop {
            0% { transform: rotate(0deg); opacity: 1; }
            20% { transform: rotate(10deg); top: +=20px; }
            100% { top: 1000px; transform: rotate(45deg); opacity: 0; }
        }

        .controls { position: fixed; bottom: 20px; right: 20px; display: flex; flex-wrap: wrap-reverse; justify-content: flex-end; gap: 10px; z-index: 10000; }
        .btn { background: white; border: none; padding: 12px 15px; font-size: 18px; font-weight: bold; color: #333; box-shadow: 3px 3px 10px rgba(0,0,0,0.3); cursor: pointer; border-radius: 2px; transform: rotate(-1deg); transition: transform 0.2s; min-width: 50px; }
        .btn:hover { transform: rotate(1deg) scale(1.05); background: #fff8e1; }
        .btn:disabled { opacity: 0.5; cursor: wait; background: #ccc; }
        .modal { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 10px 10px 40px 10px; max-width: 90%; max-height: 80%; box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 2px; transform: rotate(-1deg); }
        .modal-content img { max-width: 100%; max-height: 70vh; display: block; }
        .close { position: absolute; top: 5px; right: 15px; color: #333; font-size: 30px; font-weight: bold; cursor: pointer; line-height: 1; }
        #loader { display: none; margin-left: 10px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; align-self: center;}
    </style>
</head>
<body>

    <div class="viewport" id="viewport">
        <div class="board" id="board"></div>
    </div>

    <div class="controls">
        <div id="loader">Processing...</div>
        <button class="btn" id="uploadBtn" onclick="document.getElementById('fileInput').click()">üì∑ Photo</button>
        <button class="btn" onclick="changeZoom(0.1)">‚ûï</button>
        <button class="btn" onclick="changeZoom(-0.1)">‚ûñ</button>
        <button class="btn" onclick="resetView()">üéØ</button>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display: none;">

    <div id="photoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img id="modalImg" src="">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // –î–æ–±–∞–≤–∏–ª–∏ update –∏ onChildChanged
        import { getDatabase, ref, push, set, remove, update, onChildAdded, onChildRemoved, onChildChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmwGj7Rbfh6svO0RzNXObBFVG6yHFc8VI",
            authDomain: "polaroid-board-6aa2a.firebaseapp.com",
            databaseURL: "https://polaroid-board-6aa2a-default-rtdb.firebaseio.com",
            projectId: "polaroid-board-6aa2a",
            storageBucket: "polaroid-board-6aa2a.firebasestorage.app",
            messagingSenderId: "701668102528",
            appId: "1:701668102528:web:132de7069a957bec5c3165",
            measurementId: "G-J948W4RJJ2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'photos_base64');

        // --- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ü–û–ó–ò–¶–ò–ò ---
        // –ú—ã –¥–µ–ª–∞–µ–º –µ—ë –≥–ª–æ–±–∞–ª—å–Ω–æ–π (window), —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –Ω–∏–∂–µ –º–æ–≥ –µ—ë –≤—ã–∑–≤–∞—Ç—å
        window.updatePhotoPosition = function(key, newX, newY) {
            update(ref(db, 'photos_base64/' + key), {
                x: newX,
                y: newY
            });
        };

        // –°–ñ–ê–¢–ò–ï
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        const width = (img.width > MAX_WIDTH) ? MAX_WIDTH : img.width;
                        const height = (img.width > MAX_WIDTH) ? (img.height * scaleSize) : img.height;
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        // –ó–ê–ì–†–£–ó–ö–ê
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const loader = document.getElementById('loader');

        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            uploadBtn.disabled = true;
            loader.style.display = 'block';
            try {
                const base64String = await compressImage(file);
                const newPhotoRef = push(dbRef);
                await set(newPhotoRef, {
                    image_data: base64String,
                    x: (Math.random() * 400 - 200),
                    y: (Math.random() * 400 - 200),
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
            } finally {
                uploadBtn.disabled = false;
                loader.style.display = 'none';
                fileInput.value = '';
            }
        });

        // --- EVENTS FIREBASE ---

        // 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
        onChildAdded(dbRef, (snapshot) => {
            const data = snapshot.val();
            const key = snapshot.key;
            if(data && data.image_data) {
                renderPhoto(data.image_data, data.x, data.y, key);
            }
        });

        // 2. –£–¥–∞–ª–µ–Ω–∏–µ
        onChildRemoved(dbRef, (snapshot) => {
            const key = snapshot.key;
            const elementToRemove = document.getElementById(key);
            if (elementToRemove) {
                elementToRemove.classList.add('falling');
                setTimeout(() => { elementToRemove.remove(); }, 1000);
            }
        });

        // 3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø)
        onChildChanged(dbRef, (snapshot) => {
            const data = snapshot.val();
            const key = snapshot.key;
            const element = document.getElementById(key);
            
            // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –æ–Ω –°–ï–ô–ß–ê–° –ù–ï –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è –Ω–∞–º–∏
            // (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞, –∫–æ–≥–¥–∞ —è —Ç–∞—â—É, –∞ —Å–µ—Ä–≤–µ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –≤–µ—Ä–Ω—É—Ç—å –Ω–∞–∑–∞–¥)
            if (element && !element.classList.contains('dragging')) {
                element.style.left = data.x + 'px';
                element.style.top = data.y + 'px';
            }
        });


        function renderPhoto(src, x, y, key) {
            const div = document.createElement('div');
            div.className = 'polaroid';
            div.id = key; 
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            div.style.animationDelay = `-${Math.random() * 2}s`; 

            const pin = document.createElement('div');
            pin.className = 'pin';
            pin.addEventListener('mousedown', (e) => {
                e.stopPropagation(); 
                if (confirm("Delete photo?")) remove(ref(db, 'photos_base64/' + key));
            });
            pin.addEventListener('touchstart', (e) => {
                e.stopPropagation(); e.preventDefault();
                if (confirm("Delete photo?")) remove(ref(db, 'photos_base64/' + key));
            });

            const img = document.createElement('img');
            img.src = src;
            
            div.appendChild(pin);
            div.appendChild(img);
            document.getElementById('board').appendChild(div);

            div.addEventListener('mousedown', handleStart);
            div.addEventListener('touchstart', handleStart, {passive: false});
        }
    </script>

    <script>
        const viewport = document.getElementById('viewport');
        const board = document.getElementById('board');
        const modal = document.getElementById('photoModal');
        const modalImg = document.getElementById('modalImg');
        const closeBtn = document.getElementsByClassName('close')[0];

        let state = { scale: 1.0, panX: 0, panY: 0, isDraggingItem: false, isPanningBoard: false };
        let startCoords = {x:0, y:0}, startPan = {x:0, y:0}, activeItem = null, lastMoveCoords = {x:0, y:0};

        function updateTransform() {
            board.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.scale})`;
            const newSize = 20 * state.scale;
            document.body.style.backgroundSize = `${newSize}px ${newSize}px`;
            document.body.style.backgroundPosition = `${state.panX}px ${state.panY}px`;
        }
        updateTransform();

        function changeZoom(delta) {
            state.scale = Math.min(Math.max(state.scale + delta, 0.2), 3.0);
            updateTransform();
        }
        function resetView() { state.scale = 1.0; state.panX = 0; state.panY = 0; updateTransform(); }

        function getCoords(e) {
            if (e.touches && e.touches.length) return {x:e.touches[0].clientX, y:e.touches[0].clientY};
            if (e.changedTouches) return {x:e.changedTouches[0].clientX, y:e.changedTouches[0].clientY};
            return {x:e.clientX, y:e.clientY};
        }

        window.handleStart = function(e) {
            if (e.target.closest('.controls') || e.target.closest('.modal') || e.target.closest('.pin')) return;
            if(e.type === 'touchstart') e.preventDefault();
            const coords = getCoords(e);
            startCoords = coords;
            lastMoveCoords = coords;

            const clickedPolaroid = e.target.closest('.polaroid');
            if (clickedPolaroid) {
                state.isDraggingItem = true;
                activeItem = clickedPolaroid;
                activeItem.classList.add('dragging');
            } else {
                state.isPanningBoard = true;
                startPan = { x: state.panX, y: state.panY };
                viewport.style.cursor = 'grabbing';
            }
        }

        function handleGlobalMove(e) {
            if (!state.isDraggingItem && !state.isPanningBoard) return;
            e.preventDefault();
            const coords = getCoords(e);

            if (state.isPanningBoard) {
                state.panX = startPan.x + (coords.x - startCoords.x);
                state.panY = startPan.y + (coords.y - startCoords.y);
                updateTransform();
            } else if (state.isDraggingItem && activeItem) {
                const stepX = coords.x - lastMoveCoords.x;
                const stepY = coords.y - lastMoveCoords.y;
                const style = window.getComputedStyle(activeItem);
                activeItem.style.left = (parseFloat(style.left||0) + stepX/state.scale) + 'px';
                activeItem.style.top = (parseFloat(style.top||0) + stepY/state.scale) + 'px';
            }
            lastMoveCoords = coords;
        }

        function handleEnd(e) {
            if (state.isDraggingItem && activeItem) {
                const coords = getCoords(e);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª–∏–∫ (–µ—Å–ª–∏ –ø–æ—á—Ç–∏ –Ω–µ —Å–¥–≤–∏–Ω—É–ª–∏)
                if (Math.abs(coords.x - startCoords.x) < 10 && Math.abs(coords.y - startCoords.y) < 10) {
                    modal.style.display = "flex";
                    modalImg.src = activeItem.querySelector('img').src;
                } else {
                    // –ï–°–õ–ò –°–î–í–ò–ù–£–õ–ò –°–ò–õ–¨–ù–û (–∑–Ω–∞—á–∏—Ç –±—ã–ª–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ)
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!
                    if (window.updatePhotoPosition) {
                         const style = window.getComputedStyle(activeItem);
                         const finalX = parseFloat(style.left || 0);
                         const finalY = parseFloat(style.top || 0);
                         // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Firebase
                         window.updatePhotoPosition(activeItem.id, finalX, finalY);
                    }
                }

                activeItem.classList.remove('dragging');
                activeItem = null;
            }
            state.isDraggingItem = false;
            state.isPanningBoard = false;
            viewport.style.cursor = 'grab';
        }

        viewport.addEventListener('mousedown', handleStart);
        viewport.addEventListener('touchstart', handleStart, {passive: false});
        document.addEventListener('mousemove', handleGlobalMove);
        document.addEventListener('touchmove', handleGlobalMove, {passive: false});
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);

        closeBtn.onclick = () => modal.style.display = "none";
        modal.addEventListener('touchstart', (e) => { if(e.target==modal) modal.style.display="none"; });
    </script>
</body>
</html>
